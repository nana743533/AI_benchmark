# テストシナリオ

## 概要

このドキュメントはベンチマークで実施されるテストシナリオを定義します。
技術スタックに依存しない仕様です。

---

## APIテストシナリオ

### 1. 勘定科目CRUD操作

#### 1.1 作成 - 正常系
- **目的**: 新しい勘定科目を作成できる
- **手順**:
  1. POST /api/accounts で有効なデータを送信
  2. 201 Created レスポンスを確認
  3. レスポンスにidが含まれることを確認

#### 1.2 作成 - 異常系（重複コード）
- **目的**: 重複するコードで作成を拒否できる
- **手順**:
  1. 既存のコードでPOST /api/accounts
  2. 400 Bad Request または 409 Conflict を確認

#### 1.3 作成 - 異常系（必須項目欠落）
- **目的**: 必須項目がない場合にエラーを返す
- **手順**:
  1. 必須項項目を欠いてPOST /api/accounts
  2. 400 Bad Request を確認

#### 1.4 読取 - 存在するID
- **目的**: 指定したIDの勘定科目を取得できる
- **手順**:
  1. GET /api/accounts/:id
  2. 200 OK と正しいデータを確認

#### 1.5 読取 - 存在しないID
- **目的**: 存在しないIDの場合に404を返す
- **手順**:
  1. 存在しないIDでGET /api/accounts/:id
  2. 404 Not Found を確認

#### 1.6 更新 - 正常系
- **目的**: 勘定科目を更新できる
- **手順**:
  1. PUT /api/accounts/:id で更新データを送信
  2. 200 OK と更新されたデータを確認

#### 1.7 削除 - 正常系
- **目的**: 未使用の勘定科目を削除できる
- **手順**:
  1. 未使用の勘定科目でDELETE /api/accounts/:id
  2. 204 No Content を確認

#### 1.8 削除 - 使用中の科目
- **目的**: 使用中の勘定科目は削除できない
- **手順**:
  1. 仕訳で使用中の勘定科目でDELETE /api/accounts/:id
  2. 400 Bad Request または 409 Conflict を確認

---

### 2. 仕訳のバリデーション

#### 2.1 貸借一致 - 成功
- **目的**: 借方合計 = 貸方合計の仕訳を作成できる
- **手順**:
  1. 借方10,000、貸方10,000の仕訳をPOST
  2. 201 Created を確認

#### 2.2 貸借不一致 - エラー
- **目的**: 借方≠貸方の仕訳を拒否できる
- **手順**:
  1. 借方10,000、貸方9,000の仕訳をPOST
  2. 400 Bad Request を確認
  3. エラーメッセージに貸借不一致が含まれることを確認

#### 2.3 明細行が1行のみ - エラー
- **目的**: 明細行が1行のみの仕訳を拒否できる
- **手順**:
  1. 明細行が1行の仕訳をPOST
  2. 400 Bad Request を確認

#### 2.4 両方が0の明細 - エラー
- **目的**: 借方・貸方両方が0の明細を拒否できる
- **手順**:
  1. 借方0、貸方0の明細を含む仕訳をPOST
  2. 400 Bad Request を確認

---

### 3. 財務諸表の正確性検証

#### 3.1 試算表 - 借貸一致
- **目的**: 試算表で借方合計 = 貸方合計
- **手順**:
  1. 複数の仕訳を作成
  2. GET /api/reports/trial-balance
  3. totalDebit = totalCredit を確認

#### 3.2 貸借対照表 - バランス検証
- **目的**: BSで資産 = 負債 + 純資産
- **手順**:
  1. 複数の仕訳を作成
  2. GET /api/reports/balance-sheet
  3. assets.total = liabilities.total + equity.total を確認

#### 3.3 損益計算書 - 純利益計算
- **目的**: PLで当期純利益 = 収益 - 費用
- **手順**:
  1. 収益・費用を含む仕訳を作成
  2. GET /api/reports/income-statement
  3. netIncome = revenue.total - expenses.total を確認

---

### 4. エラーハンドリング

#### 4.1 400 バリデーションエラー
- **目的**: 不正なデータで400エラーを返す
- **確認事項**: 適切なエラーメッセージが含まれる

#### 4.2 404 リソース不存在
- **目的**: 存在しないリソースで404エラーを返す

#### 4.3 500 サーバーエラー
- **目的**: 予期しないエラーで500エラーを返す

---

## MCPサーバーテストシナリオ

### 1. ツール一覧の取得

#### 1.1 ツール数の確認
- **目的**: 5つのツールが定義されている
- **手順**:
  1. tools/list を実行
  2. 5つのツールが返されることを確認

#### 1.2 必須ツールの確認
- **目的**: 必須ツールがすべて含まれる
- **確認ツール**:
  - create_journal_entry
  - get_account_balance
  - list_accounts
  - generate_balance_sheet
  - generate_income_statement

---

### 2. 各ツールの実行テスト

#### 2.1 create_journal_entry - 正常系
- **手順**:
  1. 有効なパラメータでツール実行
  2. 作成された仕訳が返されることを確認

#### 2.2 create_journal_entry - 異常系（貸借不一致）
- **手順**:
  1. 貸借不一致のパラメータでツール実行
  2. エラーが返されることを確認

#### 2.3 get_account_balance - 正常系
- **手順**:
  1. 有効な勘定科目コードでツール実行
  2. 残高情報が返されることを確認

#### 2.4 get_account_balance - 存在しない科目
- **手順**:
  1. 存在しない勘定科目コードでツール実行
  2. エラーが返されることを確認

#### 2.5 list_accounts - フィルタリング
- **手順**:
  1. type="asset" でツール実行
  2. 資産の勘定科目のみが返されることを確認

#### 2.6 generate_balance_sheet
- **手順**:
  1. ツールを実行
  2. 貸借対照表データが返されることを確認
  3. verified=true を確認

#### 2.7 generate_income_statement
- **手順**:
  1. 有効な期間を指定してツール実行
  2. 損益計算書データが返されることを確認

---

### 3. 不正な入力のバリデーション

#### 3.1 必須パラメータ欠落
- **目的**: 必須パラメータがない場合にエラーを返す

#### 3.2 無効な日付形式
- **目的**: 無効な日付形式でエラーを返す

#### 3.3 無効な列挙値
- **目的**: 無効なtype値でエラーを返す

---

### 4. MCPプロトコル準拠チェック

- [ ] JSON-RPC 2.0 形式のリクエストを処理できる
- [ ] JSON-RPC 2.0 形式のレスポンスを返す
- [ ] stdio で通信できる
- [ ] エラー時に適切なerrorオブジェクトを返す

---

## E2Eテストシナリオ

### 1. Web UIからの仕訳作成フロー

#### 1.1 仕訳入力画面から作成
- **目的**: UIから仕訳を作成できる
- **手順**:
  1. 仕訳入力画面を開く
  2. 日付、摘要、明細を入力
  3. 保存ボタンをクリック
  4. 仕訳一覧で作成した仕訳を確認

#### 1.2 バリデーションエラー表示
- **目的**: 貸借不一致時にエラーが表示される
- **手順**:
  1. 貸借不一致の仕訳を入力
  2. 保存ボタンをクリック
  3. エラーメッセージが表示されることを確認

---

### 2. 財務諸表の閲覧

#### 2.1 貸借対照表閲覧
- **手順**:
  1. 貸借対照表画面を開く
  2. 資産、負債、純資産が正しく表示されることを確認
  3. 合計金額が正しいことを確認

#### 2.2 損益計算書閲覧
- **手順**:
  1. 損益計算書画面を開く
  2. 収益、費用、純利益が正しく表示されることを確認

#### 2.3 エクスポート機能
- **手順**:
  1. 財務諸表をエクスポート
  2. ファイルがダウンロードされることを確認

---

### 3. 勘定科目の管理

#### 3.1 勘定科目追加
- **手順**:
  1. 勘定科目管理画面を開く
  2. 新規作成ボタンをクリック
  3. 科目情報を入力
  4. 保存ボタンをクリック
  5. 一覧に追加されたことを確認

#### 3.2 勘定科目編集
- **手順**:
  1. 既存の勘定科目を選択
  2. 編集ボタンをクリック
  3. 科目名を変更
  4. 保存ボタンをクリック
  5. 変更が反映されたことを確認

#### 3.3 削除できない科目の確認
- **手順**:
  1. 仕訳で使用中の科目を選択
  2. 削除ボタンが無効、またはエラーメッセージを確認

---

### 4. 残高照会画面

#### 4.1 T字勘定表示
- **手順**:
  1. 勘定科目を選択
  2. T字勘定画面を開く
  3. 借方・貸方の取引履歴が正しく表示されることを確認
  4. 残高が正しく計算されていることを確認

---

## テスト成功基準

### 合格条件

- **APIテスト**: 全テストケースの90%以上が合格
- **MCPサーバーテスト**: 全テストケースが合格
- **E2Eテスト**: 全テストケースの80%以上が合格

### 自動テストによる検証

```bash
# テスト実行
make test-all

# 期待される結果
✓ APIテスト: XX/XX 合格
✓ MCPサーバーテスト: XX/XX 合格
✓ E2Eテスト: XX/XX 合格
```
